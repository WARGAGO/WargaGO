rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper functions untuk validasi
    function hasValidData() {
      return request.resource.data != null;
    }

    function isModifyingPassword() {
      return hasValidData() &&
             'password' in request.resource.data.diff(resource.data).affectedKeys();
    }

    function hasPassword() {
      return hasValidData() && 'password' in request.resource.data;
    }

    function isValidEmail(email) {
      return email is string &&
             email.size() > 5 &&
             email.size() < 100 &&
             email.matches('^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}$');
    }

    function isValidNik(nik) {
      return nik is string &&
             nik.size() == 16 &&
             nik.matches('^[0-9]+$');
    }

    function isValidPhone(phone) {
      return phone is string &&
             phone.size() >= 10 &&
             phone.size() <= 15 &&
             phone.matches('^[0-9]+$');
    }

    function isPasswordHashed(password) {
      return password is string &&
             password.size() == 64 &&
             password.matches('^[a-f0-9]+$');
    }

    // Users collection
    match /users/{userId} {
      allow read: if true;

      allow create: if
        hasValidData() &&
        'email' in request.resource.data &&
        'password' in request.resource.data &&
        'name' in request.resource.data &&
        'nik' in request.resource.data &&
        'phone' in request.resource.data &&
        'role' in request.resource.data &&
        'status' in request.resource.data &&
        isValidEmail(request.resource.data.email) &&
        isPasswordHashed(request.resource.data.password) &&
        request.resource.data.name is string &&
        request.resource.data.name.size() > 0 &&
        isValidNik(request.resource.data.nik) &&
        isValidPhone(request.resource.data.phone) &&
        (request.resource.data.role == 'warga' ||
         request.resource.data.role == 'admin') &&
        (request.resource.data.status == 'pending' ||
         request.resource.data.status == 'approved');

      allow update: if
        hasValidData() &&
        !isModifyingPassword() &&
        !('email' in request.resource.data.diff(resource.data).affectedKeys()) &&
        !('nik' in request.resource.data.diff(resource.data).affectedKeys()) &&
        (!('role' in request.resource.data.diff(resource.data).affectedKeys())) &&
        (!('status' in request.resource.data.diff(resource.data).affectedKeys())) &&
        'updatedAt' in request.resource.data;

      allow delete: if true;
    }

    // Warga collection
    match /warga/{wargaId} {
      allow read: if true;

      allow create: if hasValidData() &&
                       'nama' in request.resource.data &&
                       'nik' in request.resource.data &&
                       isValidNik(request.resource.data.nik);

      allow update: if hasValidData();
      allow delete: if true;
    }

    // Agenda collection
    match /agenda/{agendaId} {
      allow read: if true;

      allow create: if hasValidData() &&
                       'title' in request.resource.data &&
                       'type' in request.resource.data &&
                       (request.resource.data.type == 'kegiatan' ||
                        request.resource.data.type == 'broadcast');

      allow update: if hasValidData();
      allow delete: if true;

      match /broadcasts/{broadcastId} {
        allow read: if true;
        allow write: if true;
      }
    }

    // Keuangan collection
    match /keuangan/{transactionId} {
      allow read: if true;

      allow create: if hasValidData() &&
                       'type' in request.resource.data &&
                       'amount' in request.resource.data &&
                       request.resource.data.amount is number &&
                       request.resource.data.amount > 0 &&
                       (request.resource.data.type == 'pemasukan' ||
                        request.resource.data.type == 'pengeluaran');

      allow update: if hasValidData();
      allow delete: if true;

      match /pemasukan/{pemasukanId} {
        allow read: if true;
        allow write: if true;
      }

      match /pengeluaran/{pengeluaranId} {
        allow read: if true;
        allow write: if true;
      }
    }

    // Mutasi warga collection
    match /mutasi_warga/{mutasiId} {
      allow read: if true;

      allow create: if hasValidData() &&
                       'type' in request.resource.data &&
                       'wargaId' in request.resource.data &&
                       (request.resource.data.type == 'pindah_masuk' ||
                        request.resource.data.type == 'pindah_keluar' ||
                        request.resource.data.type == 'meninggal' ||
                        request.resource.data.type == 'lahir');

      allow update: if hasValidData();
      allow delete: if true;
    }

    // Notifications collection
    match /notifications/{notificationId} {
      allow read: if true;

      allow create: if hasValidData() &&
                       'userId' in request.resource.data &&
                       'title' in request.resource.data &&
                       'message' in request.resource.data;

      allow update: if true;
      allow delete: if true;
    }

    // Settings collection
    match /settings/{settingId} {
      allow read: if true;
      allow write: if true;
    }
  }
}

